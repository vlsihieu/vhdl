--YEU CAU 1: 2 LED CUOI HIEN THI GIA TRI CAI, DUNG MOT NUT NHAN DE THAY DOI GIA TRI
--YEU CAU 2: KHI NHAN BTN2 LAN 1 THI 6 LED7DOAN CON LAI HIEN THI MSSV 6 SO CUOI NHAP NHAY
				   --NHAN BTN2 LAN 2 THI 6 LED7DOAN STD_TSP
					--NHAN BTN2 LAN 3 THI 6 LED7DOAN SANGDON_PST
					--NHAN BTN2 LAN 3 THI 6 LED7DOAN DICH PHAI SANG TRAI
library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
entity BAI_3 is
	PORT(   CKHT: IN STD_LOGIC;
			-- KHAI BAO UT NHAN
			BTN_N: IN STD_LOGIC_VECTOR(3 DOWNTO 0);
			--KHAI BAO LED NEU CO
			LED: OUT STD_LOGIC_VECTOR(9 DOWNTO 0);
			--LED BAY DOAN
			SSEG0, SSEG1, SSEG2, SSEG3, SSEG4, SSEG5, SSEG6, SSEG7: OUT STD_LOGIC_VECTOR(6 DOWNTO 0);
			--DS18B20
	        DS18B20: INOUT STD_LOGIC;  							        
			-- LCD
			LCD_E   :    OUT STD_LOGIC;
			LCD_RS  :    OUT STD_LOGIC;
			LCD_RW  :    OUT STD_LOGIC;
			LCD_ON  :    OUT STD_LOGIC;
			LCD_BLON:    OUT STD_LOGIC;
			LCD_DB  :    OUT STD_LOGIC_VECTOR(7 DOWNTO 0)
	);
end  BAI_3;

architecture behavioral of BAI_3 is
--BIEN TAN SO
SIGNAL ENA10HZ, ENA5HZ, ENA2HZ: STD_LOGIC;

--NUT NHAN
SIGNAL RST, BTN1, BTN2, BTN3: STD_LOGIC;

--BIEN LED BAY DOAN
SIGNAL ENA_GIAIMA_8LED: STD_LOGIC_VECTOR(7 DOWNTO 0);

--BIEN DS18B20	
SIGNAL NHIETDO: STD_LOGIC_VECTOR(7 DOWNTO 0);
SIGNAL TEMPERATURE: STD_LOGIC_VECTOR(11 DOWNTO 0);  				-- phân giải mặc định 12bit
SIGNAL 	DS_PRESENT: STD_LOGIC;
SIGNAL DONVI_ND, CHUC_ND, TRAM_ND: STD_LOGIC_VECTOR(3 DOWNTO 0);
SIGNAL DONVI_ND_TO, CHUC_ND_TO, TRAM_ND_TO: STD_LOGIC_VECTOR(47 DOWNTO 0);
SIGNAL DONVI_TO, CHUC_TO, TRAM_TO: STD_LOGIC_VECTOR(47 DOWNTO 0);

--BIEN LCD
SIGNAL LCD_HANG_1: STD_LOGIC_VECTOR(127 DOWNTO 0);
SIGNAL LCD_HANG_2: STD_LOGIC_VECTOR(127 DOWNTO 0);
SIGNAL LCD_CHU: STD_LOGIC_VECTOR(79 DOWNTO 0); --HIEN THI BAO NHIEU O TREN LCD THI KHAI BAO BAY NHIEU
SIGNAL LCD_MSSV: STD_LOGIC_VECTOR(87 DOWNTO 0);

--BIEN DEM BCD
SIGNAL DONVI_GH, CHUC_GH: STD_LOGIC_VECTOR(3 DOWNTO 0);
SIGNAL DONVI, CHUC, TRAM: STD_LOGIC_VECTOR(3 DOWNTO 0);

-- BIEN KHAC
SIGNAL TT: STD_LOGIC;
SIGNAL Q: STD_LOGIC_VECTOR(1 DOWNTO 0);
 
 
BEGIN
	-- XU LY NUT NHAN
	RST <= NOT BTN_N(0);
	
	CHIA_10ENA: ENTITY WORK.CHIA_10ENA
	PORT MAP(	CKHT    => CKHT,
				ENA2HZ  => ENA2HZ,
				ENA5HZ  => ENA5HZ, 
				ENA10HZ => ENA10HZ
			);
	CHONGDOI_LAMHEP_4BTN: ENTITY WORK.CD_4BTN
	PORT MAP ( 	 CKHT  => CKHT,
				 BTN_N => BTN_N,
                 BTN1  => BTN1,-- BEN TIN HIEN NUT NHAN DEN MACH DEM, HOAC VAO MACH CAI GIOI HAN
			     BTN2  => BTN2
                 );
	
    -- ENA_SS CHO MẠCH ĐẾM    
	MACH_ENA_SS: ENTITY WORK.DEM_1BIT
	PORT MAP(
				ENA_DB => BTN1,
				CKHT   => CKHT,
				RST    => RST,
				Q      => ENA_SS
				);	
				 
  	-- XU LY NHIET DO   								
	NHIETDO <= TEMPERATURE(11 DOWNTO 4);

	DS18B20_TEMPERATURE: ENTITY WORK.DS18B20_TEMPERATURE     			
		PORT MAP(	CKHT 		=> CKHT,    --IN
				RST		=> RST,     -- IN
				DS18B20		=> DS18B20,   -- IN/OUT
				DS_PRESENT	=> DS_PRESENT, -- OUT
				TEMPERATURE_OUT	=> TEMPERATURE); -- OUT

	HEXTOBCD8BIT: ENTITY WORK.HEXTOBCD_8BIT						
	PORT MAP(	SOHEX8BIT	=> NHIETDO,
			      TRAM		=> TRAM_ND,--DEM DI HIEN THI HOAC CHUYEN QUA SO TO ROI MOI HIEN THI
			      CHUC		=> CHUC_ND,
			      DONVI		=> DONVI_ND);
				  
	-- XU LY LCD	
	LCD_RW    <= '0';
	LCD_ON    <= '1';
	LCD_BLON  <= '1';
    -- KHỞI TẠO SỐ LỚN
	LCD_KHOITAO_HIENTHI: ENTITY WORK.LCD_KHOITAO_HIENTHI_CGRAM_SO_TO
	PORT MAP(LCD_DB     => LCD_DB,
				LCD_E      => LCD_E,
				LCD_RS     => LCD_RS,
				LCD_RST    => RST,
				LCD_CK     => CKHT,
				LCD_HANG_1 => LCD_HANG_1,
				LCD_HANG_2 => LCD_HANG_2);
    --CHUYEN SO NHO THANH SO TO
	LCD_GIAI_MA_DONVI_ND: ENTITY WORK.LCD_GIAI_MA_SO_TO -- GIẢI MÃ ĐƠN VỊ NHIỆT ĐỘ SỐ TO
	PORT MAP( SO_GIAI_MA => DONVI_GH,      -- dua so can giai ma vao day, type BCD
			  LCD_MA_TO  => DONVI_GH_TO);
	-- GÁN DỮ LIỆU ĐỂ HIỂN THỊ		
   LCD_GAN_DULIEU_HIENTHI: ENTITY WORK.LCD_GAN_DULIEU_1SO_TO -- GÁN DỮ LIỆU ĐỂ HIỂN THỊ
	PORT MAP ( 
				LCD_HANG_1       => LCD_HANG_1,
				LCD_HANG_2       => LCD_HANG_2,
				DONVI_GH         => DONVI_GH, 
				CHUC_GH          => CHUC_GH,  
				TT 				 => TT,
                CHUC_GH_TO       => CHUC_GH_TO, 
				DONVI_GH_TO      => DONVI_GH_TO       
				
				);

    -- XU LY LED BAY DOAN
    ENA_GIAIMA_8LED <= "10000011";--SO LED CAN HIEN THI
	HIENTHI_1LED: ENTITY WORK.GIAIMA_HIENTHI_8LED_7DOAN
		PORT MAP(	
				LED70 => DONVI_ND,  --- DEM MA BCD VAO HIEN THI LED 7DOAN
				LED71 => CHUC_ND, 
				LED72 => X"F",
				LED73 => X"F",
				LED74 => X"F",
				LED75 => X"F",
				LED76 => X"F",
				LED77 => TTHT,
				ENA_GIAIMA_8LED => ENA_GIAIMA_8LED,
				SSEG0	=> SSEG0,
				SSEG1	=> SSEG1,
				SSEG2	=> SSEG2,
				SSEG3	=> SSEG3,
				SSEG4	=> SSEG4,
				SSEG5	=> SSEG5,
				SSEG6	=> SSEG6,
				SSEG7	=> SSEG7);
				
	DEM_2SO: ENTITY WORK.DEM_2SO_UD
	PORT MAP(	CKHT		=> CKHT,
				RST		=> RST,
				ENA_DB	=> ENA2HZ, -- xung DEM
				ENA_SS   => ENA_SS, -- CHO PHEP DEM HOAC KHONG
				DONVI		=> DONVI, 
				CHUC		=> CHUC,
				UD => UD_REG);-- UD_REG =0 DEM LEN, UP_REG = 1 DEM XUONG
 
END Behavioral;